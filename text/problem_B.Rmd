\section{Problem B: Permutation test}

\subsection{1.}

We download the data file `bilirubin.txt` and display the logarithms of the concentrations in a boxplot. This can be seen in figure \@ref(fig:boxplot).

```{r}

# ############
# Prepare data
# ############

bilirubin <- read.table("../files/bilirubin.txt", header = TRUE) %>% as_tibble()

```

(ref:boxplot) Boxplot of the logarithms of the concentrations of bilirubin (mg/dL) in blood samples from three young men, denoted p1, p2 and p3.

```{r boxplot, fig.cap = "(ref:boxplot)"}

# ##############
# Create boxplot
# ##############

ggplot(data = bilirubin) +
  geom_boxplot(aes(x = pers, y = log(meas), fill = pers)) +
  scale_fill_discrete(guide = FALSE) +
  labs(x = "person",
       y = expression(log(meas)))

```

From the box plot we can see that the concentrations of bilirubin is quite a lot higher for person 3 than for persons 1 and 2. The variance in the values of person 2 is also a lot smaller than that of the other two persons. \todo[inline]{Don't know how much I should say here...}

We fit the logarithms of concentrations as a linear model using the function `lm()` in `R`. The linear model becomes

\begin{equation}
(\#eq:lm)
\log Y_{ij} = \beta_i + \varepsilon_{ij};\ i = 1, 2, 3 \text{ and } j = 1, ..., n_i.
\end{equation}

To test the hypothesis $H_0:\ \beta_1 = \beta_2 = \beta_3$ versus $H_1:$ "at leat one of the $\beta$'s are different", we compute the F-statistic of the linear model.

```{r}
# ########################################
# Fit linear model and compute F-statistic
# ########################################


lm <- lm(log(meas) ~ pers, data = bilirubin)

s <- summary(lm)
f <- s$fstatistic
fval <- f[1]

```

The F-statistic has a value of `r format(fval, digits = 3)` on 2 and 26 degrees of freedom, giving a p-value of `r format(pf(f[1], f[2], f[3], lower.tail = FALSE), digits = 3)`. At a $0.05$ significance level we reject $H_0$, meaning that the concentration of bilirubin is not identical for each person.

\subsection{2.}

The function `permTest()` generates a permutation of the data between the three individuals, fits the model described in \@ref(eq:lm) and returns the computed F-statistic. This is done $n$ times, where $n$ is some arbitrary number. The function can be seen below.

```{r permTest}
```

\subsection{3.}

We perform a permutation test using the function `permTest()` with $n = 999$. A histogram with all the computed F-statistics can be seen in figure \@ref(fig:permtest).

(ref:permtest) Histogram displaying the computed F-statistic for all 999 premutations of the bilirubin data. The F-statistic for the original data is displayed with a vertical line.

```{r permtest, fig.cap = "(ref:permtest)"}
# ###########################################
# Do a permutation test of the bilirubin data
# ###########################################

n <- 999

f_vec <- permTest(data = bilirubin, n = n)

ggplot(data = as.tibble(f_vec)) +
  geom_histogram(aes(x = value), bins = 50, boundary = 0) +
  geom_vline(xintercept = fval) +
  labs(x = "F-statistic")


p_val <- length(which(f_vec >= fval)) / n

```

We see that most of the F-statistics from the permutation test are smaller than that of the original data.
The p-value is calculated by finding the fraction of the permutated F-statistics that are larger or equal to the one from the original data. The samples from the permutation test are generated by assuming that all $\beta$'s are equal, and the p-value thus becomes an estimate of the probability of finding more extreme results than the original F-statistic when $H_0$ is true.
We find the p-value to be `r format(p_val, digits = 3)`. This means that on a $0.05$ significance level, the hypothesis that all three persons are equal is still rejected. 

\todo[inline]{this might be larger than 0.05. Check this before delivery!!!!!!!}


